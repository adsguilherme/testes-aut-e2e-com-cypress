# Testando o fluxo de _Sign up_

O fluxo de _Sign up_ da aplica√ß√£o **Scratch** √© composto de 3 etapas:

1. O(A) usu√°rio(a) preenche seu e-mail, uma senha e confirma√ß√£o da senha e pressiona o bot√£o de <kbd>Sign up</kbd>
2. O(A) usu√°rio(a) √© redirecionado(a) para um formul√°rio para preenchimento de um c√≥digo de confirma√ß√£o, enquanto tal c√≥digo √© enviado para o e-mail preenchido no passo 1
3. O(A) usu√°rio(a) digita o c√≥digo de confirma√ß√£o recebido por e-mail para finalizar o registro

Voc√™ deve estar se perguntando, "e como eu testo este fluxo com o Cypress?"

Te apresento o servi√ßo [Mailosaur](https://mailosaur.com), o qual fornece um servidor SMTP para recebimentos de e-mails.
E tem mais! O time do Mailosaur mant√©m uma biblioteca para facilmente integrar com o Cypress, o [`cypress-mailosaur`](https://www.npmjs.com/package/cypress-mailosaur).

> **Obs.:** O Mailosaur fornece um _trial_ gr√°tis de duas semanas, o qual j√° √© o suficiente para as necessidades do curso e voc√™ pode facilmente fazer o registro usando, por exemplo, sua conta no GitHub.

## Exerc√≠cio

1. Crie uma conta _trial_ no Mailosaur (um _server_ ser√° criado automaticamente)
2. Acesse a aba API e crie uma _Server API Key_ (<kbd>Create a key</kbd>)

> **Obs. 2:** Caso voc√™ prefira, pode seguir os passos a partir da [documenta√ß√£o oficial do Mailosaur](https://mailosaur.com/docs/managing-your-account/api-keys/#what-are-server-api-keys).

3. Guarde os valores _Server ID_ e _API Key_ (clique em _Reveal Key_ para revelar sua _Key_)
4. Atualize o conte√∫do do arquivo `cypress.env.json` com o seguinte, substituindo os valores das vari√°veis que iniciam com `MAILOSAUR_` pelos valores obtidos a partir do seu _server_ no Mailosaur:

```json
{
  "USER_PASSWORD": "s3Cre7P@sSw0rd",
  "MAILOSAUR_SERVER_ID": "your-mailosaur-id-here",
  "MAILOSAUR_API_KEY": "your-mailosaur-api-key-here"
}
```

> **Obs. 3:** N√£o precisa mudar o valor do `USER_PASSWORD`.

5. Atualize tamb√©m o conte√∫do do arquivo `cypress.env.example.json` com o seguinte:

```json
{
  "USER_PASSWORD": "s3Cre7P@sSw0rd",
  "MAILOSAUR_SERVER_ID": "your-mailosaur-id-here",
  "MAILOSAUR_API_KEY": "your-mailosaur-api-key-here"
}
```

> **Obs. 4:** Neste arquivo, pode deixar os valores conforme acima. N√£o exponha dados sens√≠veis neste arquivo visto que ele ser√° versionado. A id√©ia √© ele ser um arquivo de exemplo, conforme seu nome sugere.

6. O _Sign up_ depende de um email ainda n√£o cadastrado e para isso iremos utilizar o `faker`. Al√©m disso, tamb√©m precisamos instalar o `cypress-mailosaur`. Portanto, no terminal de linha de comando, na raiz do projeto, execute o comando `npm install cypress-mailosaur@2.3.3 faker@5.5.3 --save-dev` (ou `npm i cypress-mailosaur@2.3.3 faker@5.5.3 -D` para a vers√£o curta)
7. No arquivo `cypress/support/index.js`, importe o `cypress-mailosaur` (`import 'cypress-mailosaur'`)
8. No diret√≥rio `cypress/integration/`, crie um arquivo chamado `signup.spec.js` com o seguinte conte√∫do:

```js
// cypress/integration/signup.spec.js

it('successfully signs up using confirmation code sent via email', () => {
  const faker = require('faker')
  const emailAddress = `${faker.datatype.uuid()}@${Cypress.env('MAILOSAUR_SERVER_ID')}.mailosaur.net`
  const password = Cypress.env('USER_PASSWORD')

  cy.intercept('GET', '**/notes').as('getNotes')
  cy.visit('/signup')
  cy.get('#email').type(emailAddress)
  cy.get('#password').type(password, { log: false })
  cy.get('#confirmPassword').type(password, { log: false })
  cy.contains('button', 'Signup').click()
  cy.get('#confirmationCode').should('be.visible')

  cy.mailosaurGetMessage(Cypress.env('MAILOSAUR_SERVER_ID'), {
    sentTo: emailAddress
  }).then(message => {
    const confirmationCode = message.html.body.match(/\d{6}/)[0]
    cy.get('#confirmationCode').type(`${confirmationCode}{enter}`)

    cy.wait('@getNotes')
    cy.contains('h1', 'Your Notes').should('be.visible')
  })
})
```

9. Perceba que no teste estamos navegando para a p√°gina de _Sign up_ pela URL relativa `/signup`, portanto, adicione a propriedade `baseUrl` ao arquivo `cypress.json` com o valor `https://notes-serverless-app.com`. Dessa forma, quando o comando `cy.visit('/signup)` for executado, a URL relativa de `/signup` ser√° concatenada com o valor da `baseUrl`, resultando na visita ao endere√ßo completo (`https://notes-serverless-app.com/signup`).

10. Execute o teste rec√©m criado com o comando `npx cypress run --spec cypress/integration/signup.spec.js`

> **Obs. 5:** Siga adiante para o exerc√≠cio extra quando o teste estiver passando.
>
> **Obs. 6:** Caso o teste falhe devido ao _timeout default_ do Cypress (de `4000` milissegundos) n√£o ser o suficiente em seu ambiente, adicione ao arquivo `cypress.json` a propriedade `defaultCommandTimeout` com um valor n√£o maior que `30000` milissegundos). Sugiro tentar `10000`, se n√£o for o suficiente, `15000` e assim por diante.
>
> **Obs. 7:** Dependendo das configura√ß√µes do seu computador, ao utilizar o Cypress _Runner_, ou ao rodar os testes em modo _headless_, √© poss√≠vel que voc√™ se depare com o erro `Cypress detected policy settings on your computer that may cause issues`. Caso isso ocorra, consulte a [documenta√ß√£o oficial do Cypress](https://docs.cypress.io/guides/references/error-messages#Cypress-detected-policy-settings-on-your-computer-that-may-cause-issues) e analise as poss√≠veis solu√ß√µes para o seu caso espec√≠fico.

## Exerc√≠cio extra - movendo a l√≥gica do _Sign up_ para um comando customizado

O teste funciona, mas tem um tanto de l√≥gica nesse c√≥digo.

Que tal movermos parte dela para o arquivo `cypress/support/commands.js`?

1. No arquivo arquivo citado acima, escreva o seguinte c√≥digo:

```js
// cypress/support/commands.js

Cypress.Commands.add('fillSignupFormAndSubmit', (email, password) => {
  cy.visit('/signup')
  cy.get('#email').type(email)
  cy.get('#password').type(password, { log: false })
  cy.get('#confirmPassword').type(password, { log: false })
  cy.contains('button', 'Signup').click()
  cy.get('#confirmationCode').should('be.visible')
})
```

2. E ent√£o, substitua todo esse c√≥digo no arquivo de teste (`cypress/integration/signup.spec.js`) pelo comando `cy.fillSignupFormAndSubmit(emailAddress, password)`
3. Execute o teste  com o comando `npx cypress run --spec cypress/integration/signup.spec.js`

> **Obs. 8:** Lembre-se, siga adiante somente quando o teste estiver passando. ‚úÖ

## Conte√∫do relacionado ü§ì

Recentemente criei um conte√∫do sobre a integra√ß√£o do Cypress com o Mailosaur e vou deixar aqui como material de consulta auxiliar: [Testando signup que envia um c√≥digo de confirma√ß√£o por e-mail com cypress-mailosaur](https://youtu.be/T4txmk4vENM).
___

Legal! J√° temos uma das cinco funcionalidades coberta por testes.

V√° para a [aula 3](./3.md) e vamos testar a funcionalidade de _Login_.
