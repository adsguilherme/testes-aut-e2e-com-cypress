# Testando o fluxo de _Login_

Para o teste da funcionalidade de _login_, precisamos de um usu√°rio j√° cadastrado. Sugiro usar um que tenha sido criado durante o teste da funcionalidade de _Sign up_. Voc√™ pode obter os emails cadastrados em seu _server_ no Mailosaur.

## Exerc√≠cio

1. Atualize o conte√∫do do arquivo `cypress.env.json` adicionando a propriedade `USER_EMAIL` com o valor de um dos e-mails obtidos em seu _server_ no Mailosaur
2. Atualize tamb√©m o conte√∫do do arquivo `cypress.env.example.json` com o seguinte:

```json
{
  "USER_EMAIL": "a-valid-email@your-mailosaur-id.mailosaur.net",
  "USER_PASSWORD": "s3Cre7P@sSw0rd",
  "MAILOSAUR_SERVER_ID": "your-mailosaur-id-here",
  "MAILOSAUR_API_KEY": "your-mailosaur-api-key-here"
}
```

> **Obs.:** Lembre-se, neste arquivo, pode deixar os valores conforme acima. N√£o exponha dados sens√≠veis neste arquivo visto que ele ser√° versionado. A id√©ia √© ele ser um arquivo de exemplo, conforme seu nome sugere.

3. No diret√≥rio `cypress/integration/`, crie um arquivo chamado `login.spec.js` com o seguinte conte√∫do:

```js
// cypress/integration/login.spec.js

it('successfully logs in', () => {
  cy.intercept('GET', '**/notes').as('getNotes')

  cy.visit('/login')
  cy.get('#email').type(Cypress.env('USER_EMAIL'))
  cy.get('#password').type(Cypress.env('USER_PASSWORD'))
  cy.contains('button', 'Login').click()

  cy.wait('@getNotes')
  cy.contains('h1', 'Your Notes').should('be.visible')
})
```

4. Execute o teste rec√©m criado com o comando `npx cypress run --spec cypress/integration/login.spec.js`

> **Obs. 2:** Siga adiante para o exerc√≠cio extra quando o teste estiver passando.

## Exerc√≠cio extra 1 - protegendo dados sens√≠veis ainda mais

√â uma boa pr√°tica em automa√ß√£o de testes n√£o expor dados sens√≠veis em arquivos de teste, e j√° estamos fazendo isso com o uso de vari√°veis, as quais podem ser obtidas com o uso do comando `Cypress.env('VARIAVEL')`.

Por√©m, quando o teste √© executado em modo interativo, a senha "vaza" no log de comandos do Cypress. Teste para ver abrindo o Cypress _Runner_ com o comando `npx cypress open`, execute o teste de _login_ e utilize a funcionalidade de _time travel_ do Cypress para verificar a senha "vazando".

Teu exerc√≠cio √© alterar a linha do teste que preenche a senha (`cy.get('#password').type(Cypress.env('USER_PASSWORD'))`) pelo seguinte `cy.get('#password').type(Cypress.env('USER_PASSWORD'), { log: false })`.

Execute o teste em modo interativo de novo e veja que agora a senha n√£o "vaza" mais.

## Exerc√≠cio extra 2 - Movendo a l√≥gica de _login_ para um comando customizado

1. No arquivo `cypress/support/commands.js`, crie um comando customizado chamado `login`, o qual recebe dois par√¢metros, `username` e `password`
2. Mova os comandos de _login_ para tal comando
3. Atualize o teste para chamar o comando customizado rec√©m criado
4. Execute o teste ap√≥s a refatora√ß√£o para garantir que tudo continua funcionando

> **Sugest√£o:** Aproveite que o _login_ foi abstra√≠do para um comando customizado e defina valores _default_ para o `username` e `password`, caso estes n√£o sejam passados.

## Exerc√≠cio extra 3 - `cy.session`

Legal! Cobrimos o caminho feliz do fluxo de _login_, estamos protegendo bem os dados sens√≠veis e a l√≥gica do _login_ est√° em um comando customizado que agora pode ser re-aproveitado.

**Um par√™ntese.**

Os testes de CRUD, preenchimento do formul√°rio de cart√£o de cr√©dito e _Logout_ tamb√©m precisar√£o do usu√°rio autenticado no sistema.

Mas fazer o _login_ pela interface gr√°fica de usu√°rio (GUI) para testes que dependem de tal fluxo como pre-condic√£o √© uma m√°-pr√°tica, visto que torna os testes depedentes e mais lentos do que necess√°rio.

Idealmente, ter√≠amos que testar o fluxo de _login_ via GUI somente uma vez.

**Fecha par√™nteses.**

E se consegu√≠semos armazenar a sess√£o do usu√°rio no cache e ent√£o restaur√°-la antes de cada teste?

Na vers√£o 8.2.0 o Cypress lan√ßou a funcionalidade `experimentalSessionSupport` para nos ajudar exatamente com isso. üéä

Seu exerc√≠cio extra √©:

1. Atualize o arquivo `cypress.json` adiconando a propriedade `experimentalSessionSupport` com o valor `true`
2. Atualize o comando customizado de _login_ com o seguinte conte√∫do:

```js
// cypress/support/commands.js

// ... Comando de signup aqui

Cypress.Commands.add('login', (
  username = Cypress.env('USER_EMAIL'),
  password = Cypress.env('USER_PASSWORD'),
  { cacheSession = true } = {}
) => {
  const login = () => {
    cy.visit('/login')
    cy.get('#email').type(username)
    cy.get('#password').type(password, { log: false })
    cy.contains('button', 'Login').click()
    cy.contains('h1', 'Your Notes').should('be.visible')
  }

  if (cacheSession) {
    cy.session([username, password], login)
  } else {
    login()
  }
})
```

> **Obs. 4:** Observe que, agora, al√©m do comando de _login_ receber como par√¢metros `username` e `password`, ele tamb√©m pode receber como terceiro argumento um objeto de _options_ com a propriedade `cacheSession`, e seu _default_ √© `true`, ou seja, caso tal propriedade n√£o seja explicitamente passada como `false`, a sess√£o poder√° vir do cache, caso j√° exista uma.
>
> **Obs. 5:** Perceba tamb√©m que o comando de `login` agora √© armazenado em uma vari√°vel, e se o `cacheSession` for igual a `true`, utilizamos a funcionalidade `cy.session`, sen√£o, somente a fun√ß√£o de `login()` √© chamada.

3. Atualize a chamada do comando de `login` no arquivo `cypress/integration/login.js` para fazer uso da nova funcionalidade adicionada, onde para o teste de _login_ propriamente dito, n√£o queremos fazer o cache da sess√£o.

üôä üòÉ

```js
it('successfully logs in', () => {
  cy.intercept('GET', '**/notes').as('getNotes')

  cy.login(
    Cypress.env('USER_EMAIL'),
    Cypress.env('USER_PASSWORD'),
    { cacheSession: false }
  )

  cy.wait('@getNotes')
})
```

4. Execute o teste ap√≥s a refatora√ß√£o para garantir que tudo continua funcionando.

> **Obs. 6:** Vale lembrar que a funcionalidade `cy.session` ainda est√° em fase experimental. Isso significa que ainda podem haver [bugs](https://github.com/cypress-io/cypress/issues/17642) e sua API pode sofrer mudan√ßas no futuro. Portanto, deixo aqui a refer√™ncia para a [documenta√ß√£o oficial](https://docs.cypress.io/api/commands/session).

### Conte√∫dos relacionados ü§ì

Recentemente criei alguns conte√∫dos sobre o assunto e vou deixar aqui como material de consulta auxiliar:

- [Autentique testes mais r√°pido com o comando cy.session](https://talkingabouttesting.com/2021/08/07/autentique-testes-mais-rapido-com-o-comando-cy-session/)
- [Otimizando o processo de autentica√ß√£o com a funcionalidade cy.session](https://youtu.be/_rh7Ia3yuy0)

___

Mais uma funcionalidade com seu cen√°rio de caminho feliz coberto. üëç

V√° para a [aula 4](./4.md) e vamos testar o CRUD (_**C**reate, **R**ead, **U**pdate, **D**elete_) de anota√ß√µes.
